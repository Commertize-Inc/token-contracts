app.post("/api/chat", express.json(), async (req: Request, res: Response) => {
  try {
    const { message, context } = req.body;
    
    let response = "";
    let suggestedActions: string[] = [];
    
    const messageLower = message.toLowerCase();
    
    if (messageLower.includes('defi') || messageLower.includes('nexus') || messageLower.includes('lending') || messageLower.includes('borrow')) {
      response = `üíé Commertize Nexus - CRE-Focused DeFi\n\nCommertize Nexus is our advanced DeFi lending and borrowing platform:\n\n‚Ä¢ Supply Liquidity: Lend stablecoins (USDC/USDT) and earn yield\n‚Ä¢ Borrow Against Properties: Use tokenized CRE as collateral\n‚Ä¢ Automated Yield Distribution: Smart contracts distribute rental income\n‚Ä¢ Multi-Chain Support: Ethereum & Hedera blockchain\n\nHow It Works:\n1. Supply stablecoins to earn 8-12% APY\n2. Borrow against tokenized property (up to 75% LTV)\n3. Participate in DAO governance`;
      suggestedActions = ['Visit Nexus DeFi', 'Supply liquidity', 'View governance', 'Check APY rates'];
    } else if (messageLower.includes('omnigrid') || messageLower.includes('green') || messageLower.includes('solar') || messageLower.includes('renewable')) {
      response = `üå± OmniGrid - Green Infrastructure\n\nOmniGrid is Commertize's renewable energy vertical:\n\n‚Ä¢ Solar Farms: Utility-scale solar installations\n‚Ä¢ Data Centers: Renewable-powered computing facilities\n‚Ä¢ Wind Farms: Large-scale wind energy projects\n‚Ä¢ Battery Storage: Grid-scale energy storage\n\nWhy OmniGrid?\n‚Ä¢ Invest in clean energy transition\n‚Ä¢ Earn from renewable revenue streams\n‚Ä¢ Portfolio diversification with green infrastructure`;
      suggestedActions = ['View OmniGrid projects', 'Solar farm opportunities', 'Data center assets'];
    } else if (messageLower.includes('creusd') || messageLower.includes('stablecoin')) {
      response = `üíµ CREUSD - Stablecoin for Real Estate\n\nCREUSD is Commertize's stablecoin for commercial real estate:\n\n‚Ä¢ CRE-Optimized: For property transactions and yield\n‚Ä¢ Overcollateralized: Backed by tokenized assets\n‚Ä¢ Transparent: Real-time attestations\n‚Ä¢ Bridge to TradFi: Seamless USDC/USDT conversion\n\nUse Cases:\n‚Ä¢ Property investments and yield payments\n‚Ä¢ DeFi vault deposits (Nexus platform)\n‚Ä¢ Cross-border real estate transactions`;
      suggestedActions = ['CREUSD vs USDC', 'Stablecoin mechanics', 'Investment use cases'];
    } else if (messageLower.includes('tokeniz') || messageLower.includes('how') || messageLower.includes('work')) {
      response = `‚öôÔ∏è How Tokenization Works\n\nCommertize transforms real estate into digital tokens:\n\n1. Property Selection: Vetted commercial properties\n2. Legal Structure: SEC-compliant SPV creation\n3. Token Issuance: ERC-3643 compliant tokens\n4. Investor Access: Fractional ownership from $1,000\n5. Yield Distribution: Automated rental income\n\nBenefits:\n‚Ä¢ Fractional ownership (no $1M+ minimums)\n‚Ä¢ 24/7 liquidity on secondary markets\n‚Ä¢ Transparent blockchain transactions\n‚Ä¢ Automated compliance`;
      suggestedActions = ['View properties', 'Start investing', 'Security tokens explained'];
    } else if (messageLower.includes('invest') || messageLower.includes('opportunit') || messageLower.includes('propert')) {
      response = `üè¢ Investment Opportunities\n\nCommertize offers tokenized commercial real estate:\n\n‚Ä¢ Office Buildings: Class A properties in major metros\n‚Ä¢ Industrial: Warehouses and logistics centers\n‚Ä¢ Retail: Shopping centers and mixed-use\n‚Ä¢ Multifamily: Large apartment complexes\n\nTarget Returns: 8-12% annual yield\nMinimum Investment: $1,000\nLiquidity: Secondary market trading`;
      suggestedActions = ['View marketplace', 'Property analysis', 'Start KYC process'];
    } else if (messageLower.includes('market') || messageLower.includes('trend') || messageLower.includes('cap rate')) {
      response = `üìä CRE Market Insights\n\nCurrent market highlights:\n\n‚Ä¢ Cap Rates: 6-8% across major markets\n‚Ä¢ Occupancy: Office recovering, industrial strong\n‚Ä¢ Investment Volume: $400B+ annually in U.S.\n‚Ä¢ Tokenization Growth: Digital real estate expanding\n‚Ä¢ Yield Opportunities: 8-12% target returns\n\nWant property-specific analysis?`;
      suggestedActions = ['Property analysis', 'Market comparisons', 'Investment calculator'];
    } else if (messageLower.includes('qualify') || messageLower.includes('requirement') || messageLower.includes('kyc')) {
      response = `‚úÖ Investment Qualification\n\nOur tokenized approach makes investing accessible:\n\n‚Ä¢ Minimum Investment: $1,000 to start\n‚Ä¢ Accreditation: Required for Reg D offerings\n‚Ä¢ Simple KYC: Basic identity verification\n‚Ä¢ Payment Methods: USD, USDC, other digital assets\n‚Ä¢ Global Access: Invest from anywhere with compliance\n\nReady to start your investment journey?`;
      suggestedActions = ['Start KYC process', 'View properties', 'Payment options'];
    } else if (messageLower.includes('regulat') || messageLower.includes('compliance') || messageLower.includes('sec')) {
      response = `‚öñÔ∏è Regulatory Framework\n\nCommertize operates within robust frameworks:\n\n‚Ä¢ Reg D 506(c) compliant tokenized securities\n‚Ä¢ Proper investor accreditation and KYC/AML\n‚Ä¢ SEC-compliant transfer restrictions\n‚Ä¢ Global standards (U.S., EU MiCA, Singapore MAS)\n‚Ä¢ Regular third-party audits\n\nTrust and transparency are our foundation.`;
      suggestedActions = ['GENIUS Act details', 'Investor requirements', 'Audit reports'];
    } else {
      response = `üëã Hello! I'm RUNE.CTZ, your AI guide to Commertize.\n\nI can help you explore:\n\n‚Ä¢ üè¢ Tokenized commercial real estate investments\n‚Ä¢ üíé Nexus DeFi (lending & borrowing)\n‚Ä¢ üå± OmniGrid green infrastructure\n‚Ä¢ üìä Market trends and analysis\n‚Ä¢ ‚öñÔ∏è Regulatory compliance\n\nWhat interests you most?`;
      suggestedActions = ['Investment opportunities', 'How tokenization works', 'Nexus DeFi', 'OmniGrid projects'];
    }

    res.json({ response, suggestedActions });
  } catch (error) {
    console.error('Chat API error:', error);
    res.status(500).json({ 
      response: "I apologize, but I'm experiencing technical difficulties. Please try again.",
      suggestedActions: ['Try again', 'Contact support']
    });
  }
});