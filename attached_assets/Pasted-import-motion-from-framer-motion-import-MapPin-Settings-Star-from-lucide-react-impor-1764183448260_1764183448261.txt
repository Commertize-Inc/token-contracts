import { motion } from "framer-motion";
import { MapPin, Settings, Star } from "lucide-react";
import { Link } from "wouter";
import { Button } from "@/components/ui/button";
import { useState, useEffect } from 'react';
import { auth } from "@/lib/firebase";
import { useToast } from "@/hooks/use-toast";
import { useQueryClient, useQuery, useMutation } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";

interface Property {
  id: string;
  name: string;
  location?: string;
  address?: string;
  imageUrl?: string;
  propertyValue?: number;
  pricePerToken?: number;
  minInvestment: number;
  totalTokens?: number;
  tokensAvailable?: number;
  tokensSold?: number;
  status?: string;
  propertyType?: string;
  assetType?: string;
  type?: string;
  targetedIRR?: number;
  tokenizedRaiseTarget?: number;
  loanToValue?: number;
  ltv?: number;
  distributionFrequency?: string;
  squareFeet?: number;
  squareFootage?: number;
  buildingSize?: number;
  capRate?: number;
  yearBuilt?: number;
  constructionYear?: number;
  netOperatingIncome?: number;
  units?: number;
  totalUnits?: number;
  numberOfUnits?: number;
  holdPeriod?: number;
  comingSoon?: boolean;
  sponsorEntityName?: string;
  sponsorFirstName?: string;
  sponsorLastName?: string;
}

interface PropertyCardProps {
  property: Property;
  onClick?: () => void;
  isAdminMode?: boolean;
  onEdit?: () => void;
}

export function PropertyCard({ property, onClick, isAdminMode = false, onEdit }: PropertyCardProps) {
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [user, setUser] = useState(auth.currentUser);

  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged((currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // Favorite status query
  const { data: favoriteStatus } = useQuery({
    queryKey: ['favorite', property.id, user?.uid],
    queryFn: async () => {
      if (!user) return { isFavorited: false };
      const token = await user.getIdToken();
      const response = await fetch(`/api/user/favorites/check/${property.id}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) return { isFavorited: false };
      return response.json();
    },
    enabled: !!user
  });

  // Toggle favorite mutation
  const toggleFavoriteMutation = useMutation({
    mutationFn: async () => {
      if (!user) throw new Error('Must be logged in');
      return await apiRequest('/api/user/favorites/toggle', {
        method: 'POST',
        body: JSON.stringify({ propertyId: property.id })
      });
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['favorite', property.id] });
      queryClient.invalidateQueries({ queryKey: ['likedProperties'] });
      toast({
        title: data.data.isFavorited ? "Added to favorites" : "Removed from favorites",
        description: data.data.isFavorited 
          ? `${property.name} has been added to your favorites` 
          : `${property.name} has been removed from your favorites`
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to update favorites. Please try again.",
        variant: "destructive"
      });
    }
  });

  const handleFavoriteClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (!user) {
      toast({
        title: "Login required",
        description: "Please log in to save favorites",
        variant: "destructive"
      });
      return;
    }
    toggleFavoriteMutation.mutate();
  };

  const isFavorited = favoriteStatus?.isFavorited || false;

  // Calculate tokens sold percentage
  const tokensSoldPercentage = (() => {
    if (property.tokensSold && property.totalTokens && property.totalTokens > 0) {
      return ((property.tokensSold / property.totalTokens) * 100).toFixed(1);
    }
    if (property.totalTokens && property.tokensAvailable !== undefined && property.totalTokens > 0) {
      const soldTokens = Math.max(0, property.totalTokens - property.tokensAvailable);
      return ((soldTokens / property.totalTokens) * 100).toFixed(1);
    }
    return '0.0';
  })();

  // Property type display mapping
  const getPropertyTypeDisplay = () => {
    const type = property.assetType || property.type || property.propertyType;
    const typeDisplayMap: { [key: string]: string } = {
      'strip-mall': 'Strip Mall',
      'shopping-center': 'Shopping',
      'mixed-use': 'Mixed-Use',
      'office': 'Office',
      'retail': 'Retail',
      'industrial': 'Industrial',
      'multifamily': 'Multifamily',
      'warehouse': 'Warehouse',
      'hotel': 'Hotel',
      'hospitality': 'Hotel',
      'medical': 'Medical',
      'self-storage': 'Storage',
      'data-center': 'Data Center',
      'flex-space': 'Flex'
    };
    return type ? (typeDisplayMap[type] || type) : 'Property';
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      whileHover={{ y: -4, scale: 1.01 }}
      className="property-card group relative w-full bg-white border-2 border-[#D4A024] rounded-2xl overflow-hidden shadow-xl hover:shadow-2xl transition-all duration-300"
    >
      <div className="flex flex-col">
        {/* Image Panel */}
        <div className="relative w-full flex-shrink-0">
          <motion.div
            className="relative h-80 overflow-hidden"
            whileHover={{ scale: 1.05 }}
            transition={{ duration: 0.6, ease: "easeOut" }}
          >
            <div className="absolute inset-0 bg-gradient-to-t from-black/50 via-black/20 to-transparent z-20" />
            
            {/* Coming Soon Badge */}
            {property.comingSoon && (
              <div className="absolute top-4 left-4 z-30 bg-[#D4A024] text-white px-3 py-1.5 rounded-md text-xs font-semibold border border-[#B8891F]">
                COMING SOON
              </div>
            )}
            
            <img
              src={property.imageUrl || '/assets/building-modern.jpg'}
              alt={property.name}
              className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              onError={(e) => {
                const target = e.target as HTMLImageElement;
                if (!target.src.includes('building-modern.jpg')) {
                  target.src = '/assets/building-modern.jpg';
                }
              }}
            />

            {/* Status Badge */}
            {!property.comingSoon && (
              <div className="absolute top-4 left-4 z-30">
                <div className="px-4 py-1.5 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white text-xs font-medium rounded-full shadow-lg">
                  {property.status || 'Available'}
                </div>
              </div>
            )}

            {/* Favorite Button */}
            {!property.comingSoon && (
              <div className="absolute bottom-4 left-4 z-30">
                <motion.button
                  whileHover={{ scale: 1.1 }}
                  whileTap={{ scale: 0.9 }}
                  className={`w-9 h-9 backdrop-blur-sm border rounded-full flex items-center justify-center transition-all duration-300 ${
                    isFavorited 
                      ? 'bg-yellow-500 border-yellow-500 hover:bg-yellow-600' 
                      : 'bg-white/20 border-white/30 hover:bg-white/30'
                  }`}
                  onClick={handleFavoriteClick}
                  disabled={toggleFavoriteMutation.isPending}
                >
                  <Star className={`w-4 h-4 transition-all duration-300 ${isFavorited ? 'text-white fill-white' : 'text-white'}`} />
                </motion.button>
              </div>
            )}
          </motion.div>
        </div>

        {/* Content Panel */}
        <div className="flex flex-col">
          {/* Overview Section */}
          <div className="px-4 pt-3 pb-2 border-b border-gray-100">
            <div className="flex items-start justify-between gap-2 mb-2">
              <h3 className="font-light text-xl text-black leading-tight flex-1">
                {property.name}
              </h3>
              <div className="px-2 py-1 bg-yellow-50 border border-yellow-500 rounded-full flex-shrink-0">
                <span className="text-xs font-normal text-black uppercase">
                  {getPropertyTypeDisplay()}
                </span>
              </div>
            </div>
            <div className="flex items-center text-gray-600 mb-2">
              <MapPin className="w-3.5 h-3.5 mr-1 text-yellow-600 flex-shrink-0" />
              <span className="text-sm">{property.location || property.address || 'Location not specified'}</span>
            </div>
            
            {/* Progress Bar */}
            {!property.comingSoon && (
              <div>
                <div className="flex justify-between items-center text-xs text-gray-700 mb-1">
                  <span className="font-normal">Tokens Sold</span>
                  <span className="font-normal">{tokensSoldPercentage}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                  <div 
                    className="bg-gradient-to-r from-yellow-500 to-yellow-600 h-2 rounded-full transition-all duration-1000 ease-out" 
                    style={{ width: `${Math.min(100, parseFloat(tokensSoldPercentage))}%` }}
                  />
                </div>
              </div>
            )}
          </div>

          {/* Investment Info - Active Properties Only */}
          {!property.comingSoon && (
            <div className="px-4 py-3 border-b border-gray-100 space-y-2">
              {/* Property Value & Token Price */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-xs text-gray-500 mb-0.5">Property Value</div>
                  <div className="text-lg font-normal text-black">
                    {property.propertyValue ? `$${(property.propertyValue / 1000000).toFixed(1)}M` : "TBD"}
                  </div>
                </div>
                <div className="flex flex-col items-center">
                  <div className="text-xs text-gray-500 mb-0.5">Token Price</div>
                  <div className="w-14 h-14 rounded-full border-2 border-[#D4A024] bg-gradient-to-br from-yellow-50 to-white flex items-center justify-center shadow-md">
                    <div className="text-base font-normal text-black">
                      {property.pricePerToken ? `$${property.pricePerToken}` : 'TBD'}
                    </div>
                  </div>
                </div>
              </div>

              <div className="border-t border-gray-200 my-1"></div>

              {/* Key Metrics Grid */}
              <div className="grid grid-cols-2 gap-x-4 gap-y-3">
                {property.targetedIRR && (
                  <div className="flex justify-between">
                    <span className="text-sm text-gray-600">IRR</span>
                    <span className="text-sm font-normal text-black">{property.targetedIRR}%</span>
                  </div>
                )}
                {property.capRate && (
                  <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Cap Rate</span>
                    <span className="text-sm font-normal text-black">{property.capRate}%</span>
                  </div>
                )}
                {property.holdPeriod && (
                  <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Hold</span>
                    <span className="text-sm font-normal text-black">{property.holdPeriod}y</span>
                  </div>
                )}
                {(property.units || property.totalUnits || property.numberOfUnits) && (
                  <div className="flex justify-between">
                    <span className="text-sm text-gray-600">Units</span>
                    <span className="text-sm font-normal text-black">
                      {property.units || property.totalUnits || property.numberOfUnits}
                    </span>
                  </div>
                )}
                
                <div className="flex justify-between col-span-2 pt-3 mt-1 border-t border-gray-200">
                  <span className="text-sm text-gray-600">Min Investment</span>
                  <span className="text-base font-normal text-black">
                    ${(property.minInvestment / 1000).toFixed(0)}K
                  </span>
                </div>
              </div>
            </div>
          )}

          {/* Coming Soon Message */}
          {property.comingSoon && (
            <div className="px-4 py-3">
              {(property.sponsorEntityName || property.sponsorFirstName) && (
                <div className="mb-3 pb-2 border-b border-gray-200">
                  <div className="text-xs text-gray-500 mb-1">Sponsor</div>
                  <div className="text-sm font-medium text-black">
                    {property.sponsorEntityName || `${property.sponsorFirstName || ''} ${property.sponsorLastName || ''}`.trim()}
                  </div>
                </div>
              )}
              <div className="text-center py-2">
                <div className="text-sm font-medium text-gray-800 mb-1">More Details Coming Soon</div>
                <p className="text-xs text-gray-600">Investment details available shortly.</p>
              </div>
            </div>
          )}

          {/* CommertizerX AI Section */}
          {!property.comingSoon && (
            <div className="px-4 py-3 bg-gradient-to-br from-yellow-500/5 to-yellow-500/10 border-t border-yellow-500/20">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-[#D4A024] flex items-center justify-center flex-shrink-0 relative">
                  <motion.div
                    className="absolute w-6 h-6"
                    animate={{ rotate: 360 }}
                    transition={{ duration: 3, repeat: Infinity, ease: "linear" }}
                  >
                    <div className="absolute w-1 h-1 bg-white rounded-full top-0 left-1/2 transform -translate-x-1/2"></div>
                  </motion.div>
                  <motion.div
                    animate={{ rotate: -360 }}
                    transition={{ duration: 4, repeat: Infinity, ease: "linear" }}
                  >
                    <Settings className="w-4 h-4 text-white" />
                  </motion.div>
                </div>
                <div className="flex-1 min-w-0">
                  <div className="text-xs font-normal text-black uppercase tracking-wide">CommertizerX AI</div>
                  <div className="text-[10px] text-gray-600">Market Analysis â€¢ Risk Assessment</div>
                </div>
              </div>
            </div>
          )}

          {/* VIEW PROPERTY BUTTON */}
          <div className="px-4 py-3 mt-auto">
            {isAdminMode ? (
              <Button 
                onClick={(e) => {
                  e.stopPropagation();
                  if (onEdit) onEdit();
                }}
                className="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-700 hover:to-yellow-600 text-white font-normal px-4 py-2 text-sm rounded-md transition-all duration-300 shadow-lg hover:shadow-xl"
              >
                Edit Property
              </Button>
            ) : (
              <Link to={`/property/${property.id}`} className="block">
                <Button className="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-700 hover:to-yellow-600 text-white font-normal px-4 py-2 text-sm rounded-md transition-all duration-300 shadow-lg hover:shadow-xl">
                  View Property
                </Button>
              </Link>
            )}
          </div>
        </div>
      </div>
    </motion.div>
  );
}

export default PropertyCard;