import { useState, useEffect, useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { doc, getDoc, updateDoc, addDoc, collection } from "firebase/firestore";
import { auth, db } from "@/lib/firebase";
import { useParams, useLocation, Link } from "wouter";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { ArrowLeft, Loader2, DollarSign, Coins, TrendingUp, Shield, CheckCircle, Wallet, Building2 } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { motion } from "framer-motion";
import { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer } from "recharts";

interface Property {
  id: string;
  name: string;
  location: string;
  propertyValue: number;
  propertyType: string;
  propertyClass?: string;
  description?: string;
  imageUrl?: string;
  imageUrls?: string[];
  pricePerToken: number;
  totalTokens: number;
  tokensAvailable: number;
  minInvestment: number;
  targetedIRR?: number;
  targetedYield?: number;
  equityMultiple?: number;
  holdPeriod?: number;
  yearBuilt?: number;
  totalUnits?: number;
  buildingSize?: number;
  sponsorFirstName?: string;
  sponsorLastName?: string;
  sponsorEntityName?: string;
}

export default function PropertyDetails() {
  const { id } = useParams();
  const [, navigate] = useLocation();
  const { toast } = useToast();
  
  const [currentImageIndex, setCurrentImageIndex] = useState(0);
  const [numTokens, setNumTokens] = useState(1);
  const [paymentMethod, setPaymentMethod] = useState<'usd' | 'stablecoin'>('stablecoin');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showSuccessDialog, setShowSuccessDialog] = useState(false);
  const [showPercentage, setShowPercentage] = useState(true);
  const [selectedRange, setSelectedRange] = useState<'1Y' | '3Y' | '5Y' | 'Full'>('5Y');

  // Fetch property data
  const { data: property, isLoading } = useQuery<Property>({
    queryKey: ["/api/properties", id],
    queryFn: async () => {
      const response = await fetch(`/api/properties/${id}`);
      if (!response.ok) throw new Error("Property not found");
      const result = await response.json();
      return result.data;
    },
  });

  // Generate chart data
  const generateProjectedReturnsData = () => {
    const holdPeriod = property?.holdPeriod || 5;
    const annualReturn = (property?.targetedIRR || 12) / 100;
    const data = [];
    
    for (let i = 0; i <= holdPeriod; i++) {
      const cumulativeReturn = ((1 + annualReturn) ** i - 1) * 100;
      const totalValue = 100000 * (1 + annualReturn) ** i;
      data.push({
        year: i,
        formattedDate: i === 0 ? 'Start' : `Year ${i}`,
        cumulativeReturn: parseFloat(cumulativeReturn.toFixed(2)),
        totalValue: Math.round(totalValue),
        displayValue: showPercentage ? parseFloat(cumulativeReturn.toFixed(2)) : Math.round(totalValue)
      });
    }
    return data;
  };

  const handleInvestment = async () => {
    if (!auth.currentUser) {
      toast({
        title: "Authentication Required",
        description: "Please sign in to continue with your investment",
      });
      navigate("/login");
      return;
    }

    if (!property) return;

    try {
      setIsSubmitting(true);
      const totalAmount = numTokens * property.pricePerToken;

      const investmentData = {
        userId: auth.currentUser.uid,
        propertyId: id,
        propertyName: property.name,
        tokens: numTokens,
        pricePerToken: property.pricePerToken,
        totalInvestment: totalAmount,
        paymentMethod,
        timestamp: new Date().toISOString(),
        status: "pending",
      };

      await addDoc(collection(db, "investments"), investmentData);

      // Update tokens available
      const propertyRef = doc(db, "properties", id!);
      await updateDoc(propertyRef, {
        tokensAvailable: Math.max(0, property.tokensAvailable - numTokens)
      });

      setShowSuccessDialog(true);
    } catch (error) {
      toast({
        title: "Investment Failed",
        description: "There was an error processing your investment.",
        variant: "destructive",
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!property) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p>Property not found</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-background via-background to-muted/20 py-8 pb-24">
      <div className="container mx-auto px-4">
        {/* Back Button */}
        <Link href="/marketplace" className="flex items-center gap-2 text-black hover:text-black font-light mb-6">
          <ArrowLeft className="w-4 h-4" />
          Back to Properties
        </Link>

        {/* Priority Access Banner */}
        <div className="mb-8 p-6 bg-gradient-to-r from-primary/5 to-primary/10 border border-primary/20 rounded-xl">
          <h3 className="text-xl font-semibold text-primary mb-3">Priority Investment Access</h3>
          <p className="text-gray-700">Join our exclusive network of qualified investors for this premium property.</p>
        </div>

        <div className="max-w-6xl mx-auto">
          {/* Property Header */}
          <div className="mb-8">
            <h1 className="text-3xl font-light text-foreground mb-2">{property.name}</h1>
            <p className="text-base text-black font-light">{property.location}</p>
          </div>

          {/* Property Price Card */}
          <Card className="mb-8 border-2 border-primary rounded-lg shadow-lg">
            <CardContent className="p-6 text-center">
              <p className="text-sm text-black mb-2 font-light">Property Price</p>
              <p className="text-3xl font-light text-foreground">
                ${property.propertyValue?.toLocaleString() || 'TBD'}
              </p>
            </CardContent>
          </Card>

          {/* Property Images */}
          <Card className="mb-8 border-2 border-[#D4A024] rounded-lg">
            <CardContent className="p-6">
              <h2 className="text-lg font-light mb-4">Property Images</h2>
              <img
                src={property.imageUrls?.[currentImageIndex] || property.imageUrl}
                alt={property.name}
                className="w-full h-[300px] object-cover rounded-lg border"
              />
              {property.imageUrls && property.imageUrls.length > 1 && (
                <div className="grid grid-cols-6 gap-2 mt-4">
                  {property.imageUrls.slice(0, 6).map((url, index) => (
                    <button
                      key={index}
                      onClick={() => setCurrentImageIndex(index)}
                      className={`h-16 rounded overflow-hidden ${currentImageIndex === index ? "ring-2 ring-primary" : ""}`}
                    >
                      <img src={url} alt="" className="w-full h-full object-cover" />
                    </button>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Performance Chart */}
          <Card className="mb-8 border-2 border-[#D4A024] rounded-lg">
            <CardContent className="p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-light">Property Value Growth</h2>
                <div className="flex gap-2">
                  <Button variant={showPercentage ? "default" : "outline"} size="sm" onClick={() => setShowPercentage(true)}>%</Button>
                  <Button variant={!showPercentage ? "default" : "outline"} size="sm" onClick={() => setShowPercentage(false)}>$</Button>
                </div>
              </div>

              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={generateProjectedReturnsData()}>
                  <defs>
                    <linearGradient id="valueGradient" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%" stopColor="#D4A024" stopOpacity={0.3} />
                      <stop offset="100%" stopColor="#D4A024" stopOpacity={0.0} />
                    </linearGradient>
                  </defs>
                  <XAxis dataKey="formattedDate" axisLine={false} tickLine={false} />
                  <YAxis 
                    axisLine={false} 
                    tickLine={false}
                    tickFormatter={(value) => showPercentage ? `${value}%` : `$${(value / 1000).toFixed(0)}k`}
                  />
                  <Tooltip />
                  <Area type="monotone" dataKey="displayValue" stroke="#D4A024" strokeWidth={2} fill="url(#valueGradient)" />
                </AreaChart>
              </ResponsiveContainer>

              {/* KPI Cards */}
              <div className="grid grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                <div className="text-center p-4 bg-primary/10 border border-primary/30 rounded-lg">
                  <p className="text-xs text-primary uppercase mb-2">Price Per Token</p>
                  <p className="text-xl font-light">${property.pricePerToken?.toLocaleString()}</p>
                </div>
                <div className="text-center p-4 bg-white/50 border rounded-lg">
                  <p className="text-xs text-black uppercase mb-2">Target IRR</p>
                  <p className="text-lg font-light">{property.targetedIRR || 12}%</p>
                </div>
                <div className="text-center p-4 bg-white/50 border rounded-lg">
                  <p className="text-xs text-black uppercase mb-2">Cash Yield</p>
                  <p className="text-lg font-light">{property.targetedYield || 6.5}%</p>
                </div>
                <div className="text-center p-4 bg-white/50 border rounded-lg">
                  <p className="text-xs text-black uppercase mb-2">Equity Multiple</p>
                  <p className="text-lg font-light">{property.equityMultiple || 1.8}x</p>
                </div>
                <div className="text-center p-4 bg-white/50 border rounded-lg">
                  <p className="text-xs text-black uppercase mb-2">Min Investment</p>
                  <p className="text-lg font-light">${property.minInvestment?.toLocaleString()}</p>
                </div>
                <div className="text-center p-4 bg-white/50 border rounded-lg">
                  <p className="text-xs text-black uppercase mb-2">Available Tokens</p>
                  <p className="text-lg font-light">{property.tokensAvailable?.toLocaleString()}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Property Description */}
          <Card className="mb-8 border-2 border-[#D4A024] rounded-lg">
            <CardContent className="p-6">
              <h2 className="text-lg font-light mb-4">Description</h2>
              <p className="text-black font-light leading-relaxed">
                {property.description || "Property details will be populated once available."}
              </p>
            </CardContent>
          </Card>

          {/* Key Facts Table */}
          <Card className="mb-8 border-2 border-[#D4A024] rounded-lg">
            <CardContent className="p-6">
              <h2 className="text-lg font-light mb-4">Key Property Facts</h2>
              <table className="w-full text-sm">
                <tbody className="divide-y">
                  <tr><td className="py-3 font-light">Property Type</td><td className="py-3 text-right font-light">{property.propertyType} - {property.propertyClass || 'Class A'}</td></tr>
                  <tr><td className="py-3 font-light">Year Built</td><td className="py-3 text-right font-light">{property.yearBuilt || 'N/A'}</td></tr>
                  <tr><td className="py-3 font-light">Total Units</td><td className="py-3 text-right font-light">{property.totalUnits || 'N/A'}</td></tr>
                  <tr><td className="py-3 font-light">Building Size</td><td className="py-3 text-right font-light">{property.buildingSize ? `${property.buildingSize.toLocaleString()} sq ft` : 'N/A'}</td></tr>
                </tbody>
              </table>
            </CardContent>
          </Card>

          {/* Tabs for Analysis, Calculator, Documents */}
          <Tabs defaultValue="analysis" className="mb-8">
            <TabsList className="grid w-full grid-cols-3">
              <TabsTrigger value="analysis" className="data-[state=active]:bg-[#D4A024] data-[state=active]:text-white">Analysis</TabsTrigger>
              <TabsTrigger value="calculator" className="data-[state=active]:bg-[#D4A024] data-[state=active]:text-white">Calculator</TabsTrigger>
              <TabsTrigger value="documents" className="data-[state=active]:bg-[#D4A024] data-[state=active]:text-white">Documents</TabsTrigger>
            </TabsList>

            <TabsContent value="analysis" className="p-6 border rounded-lg mt-4">
              <p className="text-center text-gray-600">Deal Quality Index and Market Intelligence coming soon.</p>
            </TabsContent>

            <TabsContent value="calculator" className="p-6 border rounded-lg mt-4">
              <p className="text-center text-gray-600">Investment Calculator coming soon.</p>
            </TabsContent>

            <TabsContent value="documents" className="p-6 border rounded-lg mt-4">
              <p className="text-center text-gray-600">Property documents will be available soon.</p>
            </TabsContent>
          </Tabs>
        </div>

        {/* Sticky Investment Bar */}
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-[#D4A024] p-4 z-50">
          <div className="container mx-auto flex items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <div>
                <p className="text-xs text-gray-500">Token Price</p>
                <p className="text-lg font-semibold text-primary">${property.pricePerToken}</p>
              </div>
              <input
                type="number"
                value={numTokens}
                onChange={(e) => setNumTokens(Math.max(1, parseInt(e.target.value) || 1))}
                className="w-24 px-3 py-2 border-2 border-[#D4A024] rounded-lg text-center"
                min="1"
              />
              <div>
                <p className="text-xs text-gray-500">Total</p>
                <p className="text-lg font-semibold">${(numTokens * property.pricePerToken).toLocaleString()}</p>
              </div>
            </div>
            <Button 
              onClick={handleInvestment}
              disabled={isSubmitting}
              className="bg-[#D4A024] hover:bg-[#a67c00] text-white px-8 py-3"
            >
              {isSubmitting ? <Loader2 className="w-4 h-4 animate-spin" /> : "Invest Now"}
            </Button>
          </div>
        </div>

        {/* Success Dialog */}
        <Dialog open={showSuccessDialog} onOpenChange={setShowSuccessDialog}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <CheckCircle className="w-6 h-6 text-green-500" />
                Investment Submitted!
              </DialogTitle>
              <DialogDescription>
                Your investment of {numTokens} tokens (${(numTokens * property.pricePerToken).toLocaleString()}) has been submitted successfully.
              </DialogDescription>
            </DialogHeader>
            <DialogFooter>
              <Button onClick={() => navigate("/portfolio")}>View Portfolio</Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  );
}