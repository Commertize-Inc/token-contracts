import { useState, useRef, useEffect } from "react";
import { Send, X, Brain, RefreshCw, Copy, ThumbsUp, ThumbsDown } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { useMutation } from "@tanstack/react-query";
import { motion, AnimatePresence } from "framer-motion";
import { useToast } from "@/hooks/use-toast";

interface Message {
  id: string;
  content: string;
  role: "user" | "assistant";
  timestamp: Date;
  reactions?: { helpful?: boolean; unhelpful?: boolean };
  suggestedActions?: string[];
}

interface ChatSession {
  id: string;
  title: string;
  messages: Message[];
  lastActive: Date;
}

export default function ChatGPTWidget() {
  const [isOpen, setIsOpen] = useState(false);
  const [currentSession, setCurrentSession] = useState<ChatSession>({
    id: "default",
    title: "New Chat",
    messages: [
      {
        id: "1",
        content: "Welcome to Commertize! I'm RUNE.CTZ â€” your guide to tokenized commercial real estate.\n\nI can help you understand investment opportunities, market trends, and how tokenization works.\n\nWhat would you like to explore?",
        role: "assistant",
        timestamp: new Date(),
        suggestedActions: [
          "Investment opportunities",
          "How tokenization works", 
          "Regulatory framework",
          "CRE market trends"
        ]
      },
    ],
    lastActive: new Date()
  });
  const [inputMessage, setInputMessage] = useState("");
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);
  const { toast } = useToast();

  const sendMessageMutation = useMutation({
    mutationFn: async (message: string) => {
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          message,
          context: currentSession.messages.slice(-5)