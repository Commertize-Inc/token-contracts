name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Show pending migrations without executing"
        required: false
        type: boolean
        default: false
  push:
    branches:
      - "release/*"
      - "main"
    paths:
      - "packages/data/src/migrations/**"
      - "packages/data/src/**/*.ts"
      - ".github/workflows/migrate.yml"
  release:
    types: [published]

jobs:
  setup:
    name: Determine Environments
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set-envs.outputs.environments }}
    steps:
      - id: set-envs
        run: |
          # Workflow Dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environments=['development']" >> "$GITHUB_OUTPUT"
          # Main Branch
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environments=['preview', 'development']" >> "$GITHUB_OUTPUT"
          # Production Release (via release event)
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            echo "environments=['production', 'preview', 'development']" >> "$GITHUB_OUTPUT"
          # Production Release (via branch push - deprecated but kept for safety)
          elif [[ "${{ github.ref }}" == "refs/heads/release/production" ]]; then
            echo "environments=['production', 'preview', 'development']" >> "$GITHUB_OUTPUT"
          # Preview Release
          elif [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
            ENV_NAME=${GITHUB_REF#refs/heads/release/}
            echo "environments=['$ENV_NAME']" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::Unknown trigger or branch, defaulting to empty list"
            echo "environments=[]" >> "$GITHUB_OUTPUT"
          fi

  migrate:
    name: Run Migrations (${{ matrix.environment }})
    needs: [setup]
    if: ${{ needs.setup.outputs.environments != '[]' && needs.setup.outputs.environments != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(needs.setup.outputs.environments) }}
    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.13.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build dependencies
        run: npx turbo run build --filter=@commertize/data^...

      - name: Check pending migrations
        working-directory: packages/data
        run: pnpm migration:pending
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ matrix.environment }}

      - name: Run migrations (Dry Run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        working-directory: packages/data
        run: |
          echo "::notice::Dry run mode - migrations would be applied but are being skipped"
          pnpm migration:pending
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ matrix.environment }}

      - name: Run migrations
        if: ${{ github.event.inputs.dry_run != 'true' }}
        working-directory: packages/data
        run: pnpm migration:up
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ matrix.environment }}

      - name: Verify migrations
        working-directory: packages/data
        run: pnpm migration:pending
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ matrix.environment }}
