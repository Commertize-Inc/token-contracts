name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Show pending migrations without executing"
        required: false
        type: boolean
        default: false
  push:
    branches:
      - "main"
    tags:
      - "v*"
    paths:
      - "packages/data/src/migrations/**"
      - "packages/data/src/**/*.ts"
      - ".github/workflows/migrate.yml"
  workflow_run:
    workflows: ["Deploy to Vercel"]
    types:
      - completed

jobs:
  setup:
    name: Determine Environments
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      environments: ${{ steps.set-envs.outputs.environments }}
    steps:
      - id: set-envs
        run: |
          # Workflow Dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environments=['development']" >> "$GITHUB_OUTPUT"
          # Main Branch
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environments=['preview', 'development']" >> "$GITHUB_OUTPUT"
          # Production Release (via workflow_run from successful deploy)
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "environments=['production', 'preview', 'development']" >> "$GITHUB_OUTPUT"
          # Tagged Release
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environments=['production', 'preview', 'development']" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::Unknown trigger or branch, defaulting to empty list"
            echo "environments=[]" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build Dependencies
    needs: [setup]
    if: ${{ needs.setup.outputs.environments != '[]' && needs.setup.outputs.environments != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.13.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install

      - name: Cache turbo build setup
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Build dependencies
        run: npx turbo run build --filter=@commertize/data^...

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: packages/*/dist
          retention-days: 1

  migrate:
    name: Run Migrations (${{ matrix.environment }})
    needs: [setup, build]
    if: ${{ needs.setup.outputs.environments != '[]' && needs.setup.outputs.environments != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(needs.setup.outputs.environments) }}
    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.13.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-files
          path: packages

      - name: Check pending migrations
        working-directory: packages/data
        run: pnpm migration:pending
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ matrix.environment }}

      - name: Run migrations (Dry Run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        working-directory: packages/data
        run: |
          echo "::notice::Dry run mode - migrations would be applied but are being skipped"
          pnpm migration:pending
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ matrix.environment }}

      - name: Run migrations
        if: ${{ github.event.inputs.dry_run != 'true' }}
        working-directory: packages/data
        run: pnpm migration:up
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ matrix.environment }}

      - name: Verify migrations
        working-directory: packages/data
        run: pnpm migration:pending
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: ${{ matrix.environment }}

  deploy:
    name: Deploy to Production
    needs: [migrate]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && needs.setup.outputs.environments != '[]'
    strategy:
      matrix:
        include:
          - app: dashboard
            projectIdSecret: VERCEL_PROJECT_ID_DASHBOARD
          - app: backend
            projectIdSecret: VERCEL_PROJECT_ID_BACKEND
          - app: landing
            projectIdSecret: VERCEL_PROJECT_ID_LANDING
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[matrix.projectIdSecret] }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel project config for ${{ matrix.app }}
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy ${{ matrix.app }} to production
        run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Promote to Production
        run: vercel promote --yes --token=${{ secrets.VERCEL_TOKEN }}

  rollback:
    needs: [migrate, deploy]
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Rollback Production Deployments
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          P_DASHBOARD: ${{ secrets.VERCEL_PROJECT_ID_DASHBOARD }}
          P_BACKEND: ${{ secrets.VERCEL_PROJECT_ID_BACKEND }}
          P_LANDING: ${{ secrets.VERCEL_PROJECT_ID_LANDING }}
        run: |
          APP_IDS=("$P_DASHBOARD" "$P_BACKEND" "$P_LANDING")
          APP_NAMES=("dashboard" "backend" "landing")

          for i in "${!APP_IDS[@]}"; do
            PID="${APP_IDS[$i]}"
            NAME="${APP_NAMES[$i]}"

            if [ -z "$PID" ]; then
              echo "Skipping $NAME: No Project ID found."
              continue
            fi

            echo "Processing rollback for $NAME ($PID)..."

            # Fetch last 2 production deployments to find the previous one
            RESPONSE=$(curl -s "https://api.vercel.com/v6/deployments?projectId=$PID&target=production&limit=2&teamId=$VERCEL_ORG_ID" \
              -H "Authorization: Bearer $VERCEL_TOKEN")

            # Extract the 2nd deployment ID (index 1) which represents the previous successful state
            PREV_ID=$(echo "$RESPONSE" | jq -r '.deployments[1].uid')

            if [ "$PREV_ID" == "null" ] || [ -z "$PREV_ID" ]; then
              echo "Could not find a previous deployment to rollback to for $NAME."
              continue
            fi

            echo "Found previous deployment: $PREV_ID. initiating rollback..."

            # Execute rollback
            vercel rollback "$PREV_ID" --scope "$VERCEL_ORG_ID" --token "$VERCEL_TOKEN" --yes
          done
